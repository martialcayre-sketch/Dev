/**\n * üß† NeuroNutrition - Interface Biblioth√®que Questionnaires (Praticien)\n * \n * Interface React pour s√©lection et assignation de questionnaires\n */\n\nimport React, { useState, useEffect } from 'react';\nimport { getFunctions, httpsCallable } from 'firebase/functions';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { Badge } from '@/components/ui/badge';\nimport { toast } from 'sonner';\nimport { Search, Filter, User, Clock, Tag, CheckCircle } from 'lucide-react';\nimport type { AgeVariant } from '@neuronutrition/shared-questionnaires';\n\ninterface QuestionnaireTemplate {\n  id: string;\n  title: string;\n  category: string;\n  hasVariants: boolean;\n}\n\ninterface LibraryData {\n  templates: QuestionnaireTemplate[];\n  categories: Record<string, QuestionnaireTemplate[]>;\n  stats: {\n    totalTemplates: number;\n    totalVariants: number;\n    categoriesCount: number;\n    categories: string[];\n  };\n}\n\ninterface QuestionnaireLibraryProps {\n  patientUid: string;\n  patientAge?: number;\n  ageVariant?: AgeVariant;\n  onAssignmentSuccess?: (assigned: any[]) => void;\n}\n\nexport function QuestionnaireLibrary({\n  patientUid,\n  patientAge,\n  ageVariant = 'adult',\n  onAssignmentSuccess\n}: QuestionnaireLibraryProps) {\n  const { user } = useAuth();\n  const functions = getFunctions();\n  \n  const [library, setLibrary] = useState<LibraryData | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [selectedTemplates, setSelectedTemplates] = useState<string[]>([]);\n  const [assignmentLoading, setAssignmentLoading] = useState(false);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [selectedCategory, setSelectedCategory] = useState<string>('all');\n\n  // üìö Chargement de la biblioth√®que\n  useEffect(() => {\n    loadLibrary();\n  }, []);\n\n  const loadLibrary = async () => {\n    if (!user) return;\n    \n    try {\n      setLoading(true);\n      const getLibrary = httpsCallable(functions, 'getQuestionnaireLibrary');\n      const result = await getLibrary({});\n      \n      const data = result.data as { success: boolean; data: LibraryData };\n      if (data.success) {\n        setLibrary(data.data);\n      } else {\n        throw new Error('√âchec chargement biblioth√®que');\n      }\n    } catch (error: any) {\n      console.error('Error loading library:', error);\n      toast.error(error.message || 'Erreur lors du chargement de la biblioth√®que');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // üéØ Assignation des questionnaires s√©lectionn√©s\n  const handleAssignment = async () => {\n    if (!selectedTemplates.length) {\n      toast.error('Veuillez s√©lectionner au moins un questionnaire');\n      return;\n    }\n\n    try {\n      setAssignmentLoading(true);\n      const assignSelected = httpsCallable(functions, 'assignSelectedQuestionnaires');\n      \n      const result = await assignSelected({\n        patientUid,\n        questionnaireIds: selectedTemplates\n      });\n      \n      const data = result.data as { \n        success: boolean; \n        assigned: any[];\n        patientAge: number;\n        ageVariant: AgeVariant;\n        message: string;\n      };\n      \n      if (data.success) {\n        toast.success(\n          `‚úÖ ${data.assigned.length} questionnaires assign√©s (variante: ${data.ageVariant}, √¢ge: ${data.patientAge} ans)`\n        );\n        setSelectedTemplates([]); // Reset s√©lection\n        onAssignmentSuccess?.(data.assigned);\n      } else {\n        throw new Error('√âchec assignation');\n      }\n    } catch (error: any) {\n      console.error('Assignment error:', error);\n      toast.error(error.message || 'Erreur lors de l\\'assignation');\n    } finally {\n      setAssignmentLoading(false);\n    }\n  };\n\n  // üîç Filtrage des questionnaires\n  const filteredTemplates = library?.templates.filter(template => {\n    const matchesSearch = template.title.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                         template.category.toLowerCase().includes(searchTerm.toLowerCase());\n    const matchesCategory = selectedCategory === 'all' || template.category === selectedCategory;\n    return matchesSearch && matchesCategory;\n  }) || [];\n\n  // üìä Gestion s√©lection\n  const handleTemplateToggle = (templateId: string) => {\n    setSelectedTemplates(prev => \n      prev.includes(templateId)\n        ? prev.filter(id => id !== templateId)\n        : [...prev, templateId]\n    );\n  };\n\n  const handleSelectAll = () => {\n    if (selectedTemplates.length === filteredTemplates.length) {\n      setSelectedTemplates([]);\n    } else {\n      setSelectedTemplates(filteredTemplates.map(t => t.id));\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className=\"flex justify-center items-center p-8\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600\"></div>\n        <span className=\"ml-3 text-gray-600\">Chargement de la biblioth√®que...</span>\n      </div>\n    );\n  }\n\n  if (!library) {\n    return (\n      <div className=\"text-center p-8\">\n        <p className=\"text-red-600\">‚ùå Impossible de charger la biblioth√®que des questionnaires</p>\n        <Button onClick={loadLibrary} className=\"mt-4\">R√©essayer</Button>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* üìä Statistiques et informations patient */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex justify-between items-center\">\n            <h3 className=\"text-lg font-medium flex items-center\">\n              üìö Biblioth√®que de Questionnaires\n            </h3>\n            <div className=\"flex items-center gap-4 text-sm text-gray-600\">\n              {patientAge && (\n                <Badge variant=\"outline\" className=\"flex items-center gap-1\">\n                  <User size={14} />\n                  {patientAge} ans ({ageVariant})\n                </Badge>\n              )}\n              <Badge variant=\"outline\">\n                {library.stats.totalTemplates} questionnaires\n              </Badge>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {/* üîç Filtres et recherche */}\n          <div className=\"flex gap-4 mb-6\">\n            <div className=\"flex-1\">\n              <div className=\"relative\">\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400\" size={18} />\n                <input\n                  type=\"text\"\n                  placeholder=\"Rechercher un questionnaire...\"\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  className=\"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                />\n              </div>\n            </div>\n            <select\n              value={selectedCategory}\n              onChange={(e) => setSelectedCategory(e.target.value)}\n              className=\"px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500\"\n            >\n              <option value=\"all\">Toutes les cat√©gories</option>\n              {library.stats.categories.map(category => (\n                <option key={category} value={category}>\n                  {category.charAt(0).toUpperCase() + category.slice(1)}\n                </option>\n              ))}\n            </select>\n          </div>\n\n          {/* ‚úÖ Actions de s√©lection */}\n          <div className=\"flex justify-between items-center mb-4\">\n            <div className=\"flex items-center gap-4\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={handleSelectAll}\n                className=\"flex items-center gap-2\"\n              >\n                <Checkbox \n                  checked={selectedTemplates.length === filteredTemplates.length && filteredTemplates.length > 0}\n                  readOnly\n                />\n                {selectedTemplates.length === filteredTemplates.length ? 'Tout d√©s√©lectionner' : 'Tout s√©lectionner'}\n              </Button>\n              <span className=\"text-sm text-gray-600\">\n                {selectedTemplates.length} / {filteredTemplates.length} s√©lectionn√©s\n              </span>\n            </div>\n            <Button\n              onClick={handleAssignment}\n              disabled={!selectedTemplates.length || assignmentLoading}\n              className=\"flex items-center gap-2\"\n            >\n              {assignmentLoading ? (\n                <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white\"></div>\n              ) : (\n                <CheckCircle size={16} />\n              )}\n              Assigner {selectedTemplates.length || ''} questionnaire{selectedTemplates.length > 1 ? 's' : ''}\n            </Button>\n          </div>\n\n          {/* üìã Liste des questionnaires */}\n          <div className=\"grid gap-3\">\n            {filteredTemplates.map(template => (\n              <Card\n                key={template.id}\n                className={`cursor-pointer border transition-all ${\n                  selectedTemplates.includes(template.id)\n                    ? 'border-blue-500 bg-blue-50'\n                    : 'border-gray-200 hover:border-gray-300'\n                }`}\n                onClick={() => handleTemplateToggle(template.id)}\n              >\n                <CardContent className=\"p-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-3\">\n                      <Checkbox \n                        checked={selectedTemplates.includes(template.id)}\n                        readOnly\n                      />\n                      <div>\n                        <h4 className=\"font-medium text-gray-900\">\n                          {template.title}\n                        </h4>\n                        <div className=\"flex items-center gap-2 mt-1\">\n                          <Badge variant=\"secondary\" className=\"text-xs\">\n                            <Tag size={12} className=\"mr-1\" />\n                            {template.category}\n                          </Badge>\n                          {template.hasVariants && (\n                            <Badge variant=\"outline\" className=\"text-xs text-blue-600\">\n                              üßí Variantes √¢ge disponibles\n                            </Badge>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n\n          {filteredTemplates.length === 0 && (\n            <div className=\"text-center py-8 text-gray-500\">\n              <Filter size={48} className=\"mx-auto mb-4 opacity-50\" />\n              <p>Aucun questionnaire trouv√© pour ces crit√®res</p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}