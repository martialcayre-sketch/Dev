# Cursor AI Rules - NeuroNutrition App

## Project Identity

- **Name:** NeuroNutrition App
- **Type:** Healthcare Web Application (Practitioner-Patient Management)
- **Architecture:** pnpm Monorepo (packages partag√©s)
- **Primary Languages:** TypeScript, React, Firebase Cloud Functions Gen2
- **Environment:** Linux (Alpine), Node 24.11.1, pnpm 10.22.0+sha512.a8024f681e65c5fc6f0078d54b4d84267e65c7c8e7cf6b85d5acaa3b9e43fcbb4e0c0e4bab3b6f7eedbe59d13c43b6b42b29b6e7a5+sha512.a8024f681e65c5fc6f0078d54b4d84267e65c7c8e7cf6b85d5acaa3b9e43fcbb4e0c0e4bab3b6f7eedbe59d13c43b6b42b29b6e7a5+sha512.a8024f681e65c5fc6f0078d54b4d84267e65c7c8e7cf6b85d5acaa3b9e43fcbb4e0c0e4bab3b6f7eedbe59d13c43b6b42b29b6e7a5+sha512.a8024f681e65c5fc6f0078d54b4d84267e65c7c8e7cf6b85d5acaa3b9e43fcbb4e0c0e4bab3b6f7eedbe59d13c43b6b42b29b6e7a5+sha512.a8024f681e65c5fc6f0078d54b4d84267e65c7c8e7cf6b85d5acaa3b9e43fcbb4e0c0e4bab3b6f7eedbe59d13c43b6b42b29b6e7a5+sha512.a8024f681e65c5fc6f0078d54b4d84267e65c7c8e7cf6b85d5acaa3b9e43fcbb4e0c0e4bab3b6f7eedbe59d13c43b6b42b29b6e7a5+sha512.a8024f681e65c5fc6f0078d54b4d84267e65c7c8e7cf6b85d5acaa3b9e43fcbb4e0c0e4bab3b6f7eedbe59d13c43b6b42b29b6e7a5+sha512.a8024f681e65c5fc6f0078d54b4d84267e65c7c8e7cf6b85d5acaa3b9e43fcbb4e0c0e4bab3b6f7eedbe59d13c43b6b42b29b6e7a5+sha512.a8024f681e65c5fc6f0078d54b4d84267e65c7c8e7cf6b85d5acaa3b9e43fcbb4e0c0e4bab3b6f7eedbe59d13c43b6b42b29b6e7a5+sha512.a8024f681e65c5fc6f0078d54b4d84267e65c7c8e7cf6b85d5acaa3b9e43fcbb4e0c0e4bab3b6f7eedbe59d13c43b6b42b29b6e7a5+sha512.a8024f681e65c5fc6f0078d54b4d84267e65c7c8e7cf6b85d5acaa3b9e43fcbb4e0c0e4bab3b6f7eedbe59d13c43b6b42b29b6e7a5+sha512.a8024f681e65c5fc6f0078d54b4d84267e65c7c8e7cf6b85d5acaa3b9e43fcbb4e0c0e4bab3b6f7eedbe59d13c43b6b42b29b6e7a5+sha512.a8024f681e65c5fc6f0078d54b4d84267e65c7c8e7cf6b85d5acaa3b9e43fcbb4e0c0e4bab3b6f7eedbe59d13c43b6b42b29b6e7a5+sha512.a8024f681e65c5fc6f0078d54b4d84267e65c7c8e7cf6b85d5acaa3b9e43fcbb4e0c0e4bab3b6f7eedbe59d13c43b6b42b29b6e7a5
- **Storage:** Root-only Firestore `questionnaires/{templateId}_{patientUid}`

## Code Style

### TypeScript

- Use strict mode with explicit return types for public functions
- Prefer `type` over `interface` for simple types
- Use Zod for runtime validation
- No `any` types unless absolutely necessary
- Use `Record<string, T>` for objects with unknown keys

### React

- Functional components only (no class components)
- Use hooks (useState, useEffect, useMemo, useCallback)
- Lazy load heavy components with React.lazy()
- Custom hooks for reusable logic (prefix with `use`)
- Error boundaries for all route components

### File Organization

- Components: PascalCase (e.g., `PatientDashboard.tsx`)
- Hooks: camelCase with `use` prefix (e.g., `useAuth.ts`)
- Utils: camelCase (e.g., `calculateScore.ts`)
- Types: PascalCase in `types.ts` or `@types` folder
- Tests: Same name with `.test.ts` or `.spec.ts` suffix

### Imports

- Group imports: React ‚Üí External ‚Üí Internal ‚Üí Types
- Use absolute imports via path aliases (`@/...`)
- Import specific functions, not entire libraries
- Prefer named exports over default exports

## Performance Rules

### Bundle Size

- Keep chunks under 500KB (gzip)
- Use code splitting for routes
- Lazy load charts and heavy components
- Manual chunks: react-vendor, firebase, charts, questionnaires

### React Optimization

- Memoize expensive calculations with useMemo
- Wrap callback functions with useCallback when passed as props
- Use React.memo() for components with expensive renders
- Debounce user input handlers (auto-save, search)

### Firebase

- Use root collection `questionnaires/{templateId}_{patientUid}` for all questionnaire operations
- No subcollections: legacy `patients/{uid}/questionnaires/{id}` has been purged
- Use idempotency documents for submit/complete operations
- Batch Firestore writes when possible
- Use Firestore transactions for critical updates
- Cache frequently accessed data in React state
- Limit query results with `.limit()`
- Secrets managed via Firebase Secret Manager (MANUAL_ASSIGN_SECRET, MIGRATION_SECRET)

## Architecture Patterns

### Separation of Concerns

```
apps/
  patient-vite/       ‚Üí Patient UI only
  practitioner-vite/  ‚Üí Practitioner UI only
packages/
  shared-core/        ‚Üí Business logic, types
  shared-ui/          ‚Üí Reusable components
  shared-charts/      ‚Üí Chart components
  shared-api/         ‚Üí API client utilities
functions/            ‚Üí Cloud Functions (Node 20)
```

### Data Flow

```
Component ‚Üí Custom Hook ‚Üí Firebase Service ‚Üí Firestore
                ‚Üì
            Local State (useState)
```

### Error Handling

- Always wrap async operations in try-catch
- Show user-friendly error messages
- Log errors to console in development
- Use ErrorBoundary for React errors

## Security Best Practices

### Authentication

- Always check `request.auth.uid` in Firestore rules
- Validate user roles before privileged operations
- Use Firebase Auth tokens, never custom tokens
- Never store sensitive data in localStorage

### Data Validation

```typescript
// Always validate user input with Zod
const patientSchema = z.object({
  email: z.string().email(),
  displayName: z.string().min(2),
});

const validated = patientSchema.parse(userInput);
```

### Firestore Rules

- Patients can only read/write their own data
- Practitioners can read their patients' data
- Use `get()` to verify relationships
- Never trust client-side data

## Testing Requirements

### Unit Tests (Jest)

- Test business logic in `shared-core`
- Test custom hooks
- Test utility functions
- Aim for 80% coverage on critical paths

### E2E Tests (Playwright)

- Test authentication flows
- Test questionnaire submission
- Test practitioner-patient workflows
- Run against Firebase emulators

## Git Workflow

### Commit Messages

```
feat: add Life Journey questionnaire
fix: resolve bundle size issue in practitioner app
refactor: extract chart components to shared package
test: add E2E tests for patient signup
docs: update deployment guide
```

### Branch Strategy

- `main`: production-ready code
- `dev`: development branch (optional)
- Feature branches: `feat/questionnaire-improvements`
- Bugfix branches: `fix/auth-redirect`

## Common Commands

### Development

```bash
pnpm dev:patient          # Patient app (port 3020)
pnpm dev:practitioner     # Practitioner app (port 3010)
pnpm dev:emu              # Firebase emulators
```

### Build & Deploy

```bash
pnpm build                # Build all packages (Turbo)
pnpm build:web            # Build patient + practitioner apps
firebase deploy           # Deploy all (hosting + functions)
```

### Testing

```bash
pnpm -C functions test    # Unit tests
pnpm exec playwright test # E2E tests
```

## Prohibited Patterns

### ‚ùå Never Do This

```typescript
// Don't use 'any'
const data: any = response;

// Don't import entire libraries
import _ from 'lodash';

// Don't use class components
class Dashboard extends React.Component {}

// Don't use deprecated baseUrl
{ "baseUrl": ".", "paths": {...} }

// Don't mutate state directly
state.items.push(newItem);
```

### ‚úÖ Always Do This

```typescript
// Use specific types
const data: PatientData = response;

// Import specific functions
import { debounce } from 'lodash-es';

// Use functional components
function Dashboard() {}

// Use paths without baseUrl
{ "paths": { "@/*": ["./src/*"] } }

// Use immutable updates
setState([...state.items, newItem]);
```

## Firebase Specific

### Cloud Functions

- Use 2nd gen functions (Node.js 20, region: europe-west1)
- Set region: `europe-west1`
- Use Firebase Secret Manager for secrets (no environment variables)
- Handle errors with try-catch
- Return proper HTTP status codes
- Use idempotency documents for mutations

### Firestore

- **Root-only storage**: `questionnaires/{templateId}_{patientUid}`
- Create composite indexes for complex queries
- Batch writes when creating multiple documents
- Use transactions for critical updates
- Set TTL on temporary data (idempotency docs)
- No subcollections for questionnaires (legacy pattern deprecated)

### Hosting

- Patient: `neuronutrition-app-patient.web.app`
- Practitioner: `neuronutrition-app-practitioner.web.app`
- Multi-site config in `firebase.json`

## Maintenance Scripts

### Questionnaire Data Operations

```bash
# Audit root vs subcollections consistency
node scripts/audit-questionnaires.mjs --all --csv audit.csv

# Backfill subcollections to root (if needed)
node scripts/backfill-questionnaires.mjs --all --limit 500

# Secure purge of legacy subcollections
node scripts/purge-legacy-questionnaires.mjs --all --csv purge.csv --confirm delete
```

**Note:** Legacy scripts in `scripts/_deprecated/` should NOT be used.

## Package Management

### pnpm Workspaces

- Install root deps: `pnpm add -D -w <package>`
- Install package deps: `pnpm add <package> --filter <workspace>`
- Use workspace protocol: `"@neuronutrition/shared-core": "workspace:*"`

### Turbo Cache

- Builds are cached by Turbo
- Clean cache: `pnpm exec turbo clean`
- Force rebuild: `pnpm build --force`

## Documentation Standards

### Code Comments

```typescript
/**
 * Calculate Life Journey global score (0-180 points)
 * @param answers - User answers (questionId -> value)
 * @returns Calculated scores for all 7 spheres
 */
export function calculateLifeJourneyScore(answers: Record<string, number>): LifeJourneyScores {
  // Implementation
}
```

### README Files

- Every package should have a README
- Include purpose, usage, and examples
- Document public APIs
- List dependencies and peer dependencies

## AI Assistant Context & Guidelines

### ü§ñ **Automatic Context Loading**

**IMPORTANT:** Ces 5 fichiers d'instructions IA sont syst√©matiquement charg√©s dans chaque conversation Copilot :

1. **`docs/AI_INDEX.md`** - Index r√©capitulatif et navigation des instructions IA
2. **`docs/AI_INSTRUCTIONS_SUMMARY.md`** - Vue d'ensemble ex√©cutive et checklist de validation
3. **`docs/AI_TYPESCRIPT_GUIDELINES.md`** - Guide technique d√©taill√© des patterns anti-erreurs
4. **`docs/AI_PROMPTS_TEMPLATES.md`** - Templates de prompts optimis√©s pour collaboration IA
5. **`docs/AI_CONFIGURATION_PATTERNS.md`** - Snippets de code et configurations TypeScript

### ‚ö° **R√®gles Critiques TypeScript & Node.js**

**TOUJOURS respecter ces patterns pour √©viter les erreurs:**

#### **Import Patterns par Context:**

```typescript
// ‚úÖ Cloud Functions (require bypass pour shared packages)
const { validateUser } = require('@neuronutrition/shared-core');

// ‚úÖ Frontend Apps (hook Firebase existant)
import { useFirebaseUser } from '@/hooks/useFirebaseUser';

// ‚ùå JAMAIS utiliser ces patterns probl√©matiques
import { useAuth } from '@/contexts/AuthContext'; // Hook inexistant
import { toast } from 'sonner'; // Package manquant
```

#### **Firebase Type Safety:**

```typescript
// ‚úÖ Casting explicite pour √©viter Query vs CollectionReference conflicts
const query = firestore.collection('users') as CollectionReference;
const filteredQuery = query.where('active', '==', true) as Query;
```

#### **UI Components Substitution:**

```typescript
// ‚úÖ Cr√©er substituts locaux quand @/components/ui/* manquent
const Button = ({ children, onClick, variant = 'primary' }: ButtonProps) => (
  <button className={`btn btn-${variant}`} onClick={onClick}>
    {children}
  </button>
);
```

### üìä **M√©triques de Validation Obligatoires:**

Avant tout commit, v√©rifier:

- ‚úÖ `pnpm typecheck` - 0 erreurs TypeScript
- ‚úÖ Build times < 15s par app
- ‚úÖ Bundle size < 400KB chunk principal
- ‚úÖ Cloud Functions compilation r√©ussie

### üéØ **Templates de Fix Automatique:**

Utiliser ces patterns pour r√©solution rapide d'erreurs courantes selon la documentation compl√®te dans `docs/AI_*.md`.

## AI Assistant Preferences

### When Generating Code

1. Prefer TypeScript over JavaScript
2. Use functional React patterns
3. Follow existing code style
4. Include error handling
5. Add TypeScript types/interfaces
6. Write self-documenting code
7. Add comments for complex logic

### When Suggesting Changes

1. Explain the reasoning
2. Consider bundle size impact
3. Check for breaking changes
4. Suggest tests if needed
5. Reference existing patterns in codebase

### When Debugging

1. Check Firebase console logs
2. Verify Firestore rules
3. Inspect network requests
4. Check bundle stats (stats.html)
5. Review TypeScript errors

---

**Follow these rules for consistent, maintainable, and performant code.**
