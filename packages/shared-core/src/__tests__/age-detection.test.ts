/**\n * üß™ Tests du Syst√®me de D√©tection d'√Çge - NeuroNutrition\n * \n * Tests unitaires pour valider le comportement du syst√®me d'adaptation par √¢ge\n */\n\nimport { describe, test, expect } from '@jest/globals';\nimport {\n  detectPatientAge,\n  calculateAgeInYears,\n  getAgeVariant,\n  canAssignQuestionnaires,\n  AGE_THRESHOLDS\n} from '../src/age-detection';\nimport type { PatientAgeData, AgeDetectionResult } from '../src/age-detection';\n\ndescribe('üßÆ calculateAgeInYears', () => {\n  test('calcule correctement l\\'√¢ge en ann√©es', () => {\n    const today = new Date('2025-11-14');\n    \n    // Mock de Date pour tests d√©terministes\n    jest.useFakeTimers();\n    jest.setSystemTime(today);\n    \n    expect(calculateAgeInYears('2010-05-15')).toBe(15); // Teen\n    expect(calculateAgeInYears('2015-11-14')).toBe(10); // Kid\n    expect(calculateAgeInYears('1990-03-20')).toBe(35); // Adult\n    expect(calculateAgeInYears('2025-11-13')).toBe(0);  // B√©b√©\n    \n    jest.useRealTimers();\n  });\n  \n  test('g√®re les anniversaires non encore pass√©s', () => {\n    const today = new Date('2025-11-14');\n    jest.useFakeTimers();\n    jest.setSystemTime(today);\n    \n    // Anniversaire pas encore pass√© cette ann√©e\n    expect(calculateAgeInYears('2010-12-25')).toBe(14); // Pas encore 15\n    expect(calculateAgeInYears('2010-11-14')).toBe(15); // Anniversaire aujourd'hui\n    \n    jest.useRealTimers();\n  });\n  \n  test('rejette les dates invalides', () => {\n    expect(() => calculateAgeInYears('date-invalide')).toThrow('Date de naissance invalide');\n    expect(() => calculateAgeInYears('')).toThrow('Date de naissance invalide');\n  });\n});\n\ndescribe('üéØ getAgeVariant', () => {\n  test('classe correctement les tranches d\\'√¢ge', () => {\n    expect(getAgeVariant(25)).toBe('adult');\n    expect(getAgeVariant(18)).toBe('adult'); // Limite adult\n    expect(getAgeVariant(17)).toBe('teen');\n    expect(getAgeVariant(13)).toBe('teen');  // Limite teen\n    expect(getAgeVariant(12)).toBe('kid');\n    expect(getAgeVariant(5)).toBe('kid');\n    expect(getAgeVariant(0)).toBe('kid');\n  });\n  \n  test('respecte les seuils d√©finis', () => {\n    expect(getAgeVariant(AGE_THRESHOLDS.ADULT_MIN)).toBe('adult');\n    expect(getAgeVariant(AGE_THRESHOLDS.ADULT_MIN - 1)).toBe('teen');\n    expect(getAgeVariant(AGE_THRESHOLDS.TEEN_MIN)).toBe('teen');\n    expect(getAgeVariant(AGE_THRESHOLDS.TEEN_MIN - 1)).toBe('kid');\n  });\n});\n\ndescribe('üß† detectPatientAge', () => {\n  const mockPatient = {\n    uid: 'patient-123',\n    birthDate: '2010-05-15'\n  };\n  \n  beforeEach(() => {\n    const today = new Date('2025-11-14');\n    jest.useFakeTimers();\n    jest.setSystemTime(today);\n  });\n  \n  afterEach(() => {\n    jest.useRealTimers();\n  });\n  \n  test('d√©tecte correctement un adolescent', () => {\n    const result = detectPatientAge(mockPatient);\n    \n    expect(result.isValid).toBe(true);\n    expect(result.ageInYears).toBe(15);\n    expect(result.variant).toBe('teen');\n    expect(result.error).toBeUndefined();\n  });\n  \n  test('d√©tecte un enfant', () => {\n    const kidPatient = {\n      uid: 'kid-123',\n      birthDate: '2018-01-01'\n    };\n    \n    const result = detectPatientAge(kidPatient);\n    \n    expect(result.isValid).toBe(true);\n    expect(result.ageInYears).toBe(7);\n    expect(result.variant).toBe('kid');\n  });\n  \n  test('d√©tecte un adulte', () => {\n    const adultPatient = {\n      uid: 'adult-123',\n      birthDate: '1985-06-10'\n    };\n    \n    const result = detectPatientAge(adultPatient);\n    \n    expect(result.isValid).toBe(true);\n    expect(result.ageInYears).toBe(40);\n    expect(result.variant).toBe('adult');\n  });\n  \n  test('g√®re les patients sans date de naissance', () => {\n    const patientSansBirthDate = {\n      uid: 'no-birth-123'\n    };\n    \n    const result = detectPatientAge(patientSansBirthDate);\n    \n    expect(result.isValid).toBe(false);\n    expect(result.variant).toBe('adult'); // Fallback\n    expect(result.error).toContain('Date de naissance manquante');\n  });\n  \n  test('rejette les √¢ges invalides', () => {\n    const patientFutur = {\n      uid: 'future-123',\n      birthDate: '2030-01-01'\n    };\n    \n    const result = detectPatientAge(patientFutur);\n    \n    expect(result.isValid).toBe(false);\n    expect(result.error).toContain('√Çge invalide');\n  });\n  \n  test('rejette les √¢ges excessifs', () => {\n    const patientTresVieux = {\n      uid: 'old-123',\n      birthDate: '1850-01-01'\n    };\n    \n    const result = detectPatientAge(patientTresVieux);\n    \n    expect(result.isValid).toBe(false);\n    expect(result.error).toContain('√Çge invalide');\n  });\n});\n\ndescribe('üîí canAssignQuestionnaires', () => {\n  beforeEach(() => {\n    const today = new Date('2025-11-14');\n    jest.useFakeTimers();\n    jest.setSystemTime(today);\n  });\n  \n  afterEach(() => {\n    jest.useRealTimers();\n  });\n  \n  test('autorise l\\'assignation avec identification valide', () => {\n    const patientValide = {\n      uid: 'valid-123',\n      birthDate: '2010-05-15'\n    };\n    \n    const result = canAssignQuestionnaires(patientValide);\n    \n    expect(result.canAssign).toBe(true);\n    expect(result.requiresIdentification).toBe(false);\n  });\n  \n  test('refuse l\\'assignation sans identification', () => {\n    const patientSansIdent = {\n      uid: 'no-ident-123'\n    };\n    \n    const result = canAssignQuestionnaires(patientSansIdent);\n    \n    expect(result.canAssign).toBe(false);\n    expect(result.requiresIdentification).toBe(true);\n    expect(result.reason).toContain('identification');\n  });\n  \n  test('refuse l\\'assignation avec donn√©es invalides', () => {\n    const patientInvalide = {\n      uid: 'invalid-123',\n      birthDate: 'date-invalide'\n    };\n    \n    const result = canAssignQuestionnaires(patientInvalide);\n    \n    expect(result.canAssign).toBe(false);\n  });\n});\n\ndescribe('üéØ Cas d\\'usage r√©els', () => {\n  beforeEach(() => {\n    const today = new Date('2025-11-14');\n    jest.useFakeTimers();\n    jest.setSystemTime(today);\n  });\n  \n  afterEach(() => {\n    jest.useRealTimers();\n  });\n  \n  test('Sc√©nario: Enfant de 8 ans avec parents', () => {\n    const enfant = {\n      uid: 'enfant-8ans',\n      birthDate: '2017-03-10'\n    };\n    \n    const detection = detectPatientAge(enfant);\n    const validation = canAssignQuestionnaires(enfant);\n    \n    expect(detection.ageInYears).toBe(8);\n    expect(detection.variant).toBe('kid');\n    expect(validation.canAssign).toBe(true);\n    \n    // L'enfant devrait n√©cessiter l'aide des parents\n    // (cette logique sera dans les composants React)\n  });\n  \n  test('Sc√©nario: Adolescent de 16 ans autonome', () => {\n    const ado = {\n      uid: 'ado-16ans',\n      birthDate: '2009-07-22'\n    };\n    \n    const detection = detectPatientAge(ado);\n    \n    expect(detection.ageInYears).toBe(16);\n    expect(detection.variant).toBe('teen');\n    // Les adolescents peuvent r√©pondre seuls\n  });\n  \n  test('Sc√©nario: Adulte standard', () => {\n    const adulte = {\n      uid: 'adulte-standard',\n      birthDate: '1990-11-14'\n    };\n    \n    const detection = detectPatientAge(adulte);\n    \n    expect(detection.ageInYears).toBe(35);\n    expect(detection.variant).toBe('adult');\n  });\n  \n  test('Sc√©nario: Patient sans identification -> Blocage', () => {\n    const patientAnonyme = {\n      uid: 'anonyme-patient'\n    };\n    \n    const validation = canAssignQuestionnaires(patientAnonyme);\n    \n    expect(validation.canAssign).toBe(false);\n    expect(validation.requiresIdentification).toBe(true);\n    \n    // Conforme aux sp√©cifications:\n    // \"Pas d'assignation possible sans avoir rempli la fiche d'identification\"\n  });\n});\n\ndescribe('üîÑ Int√©gration avec assignQuestionnaires', () => {\n  test('Mock d\\'int√©gration avec la Cloud Function', async () => {\n    // Simule le comportement de assignQuestionnaires.ts\n    const mockPatientData = {\n      uid: 'integration-test',\n      identification: {\n        birthDate: '2012-09-15'\n      }\n    };\n    \n    const today = new Date('2025-11-14');\n    jest.useFakeTimers();\n    jest.setSystemTime(today);\n    \n    // √âtapes de la Cloud Function\n    const ageValidation = canAssignQuestionnaires({\n      uid: mockPatientData.uid,\n      birthDate: mockPatientData.identification.birthDate\n    });\n    \n    expect(ageValidation.canAssign).toBe(true);\n    \n    if (ageValidation.canAssign) {\n      const ageResult = detectPatientAge({\n        uid: mockPatientData.uid,\n        birthDate: mockPatientData.identification.birthDate\n      });\n      \n      expect(ageResult.ageInYears).toBe(13);\n      expect(ageResult.variant).toBe('teen');\n      \n      // Les questionnaires seraient cr√©√©s avec:\n      // - patientAge: 13\n      // - ageVariant: 'teen'\n      // - requiresParentAssistance: false\n    }\n    \n    jest.useRealTimers();\n  });\n});