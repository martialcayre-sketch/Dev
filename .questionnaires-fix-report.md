# üìã Rapport: Correction assignation questionnaires patient

**Date**: 13 novembre 2025  
**Patient concern√©**: martialcayre@live.fr  
**Probl√®me**: Questionnaires non visibles apr√®s cr√©ation du compte

---

## üî¥ Probl√®me identifi√©

Le patient ne voyait pas les questionnaires assign√©s automatiquement lors de l'activation de son compte.

### Cause racine

La fonction `activatePatient` (functions/src/index.ts) √©crivait les questionnaires **uniquement** dans la sous-collection:
```
patients/{patientId}/questionnaires/{questionnaireId}
```

Mais l'architecture Backend-First fait que l'API lit **uniquement** depuis la collection root:
```
questionnaires/{questionnaireId}
```

**R√©sultat**: Les questionnaires existaient en base de donn√©es mais n'√©taient pas visibles par l'API, donc pas affich√©s dans le frontend.

---

## ‚úÖ Correction appliqu√©e

### 1. Modification de `activatePatient`

**Fichier**: `functions/src/index.ts` (lignes 484-518)

**Avant**:
```typescript
DEFAULT_QUESTIONNAIRES.forEach((template) => {
  const questionnaireRef = db
    .collection('patients')
    .doc(patientUid)
    .collection('questionnaires')
    .doc(template.id);

  batch.set(questionnaireRef, { ...questionnaireData });
});
```

**Apr√®s**:
```typescript
DEFAULT_QUESTIONNAIRES.forEach((template) => {
  // G√©n√©rer un ID unique pour √©viter les collisions
  const uniqueId = `${template.id}_${patientUid}`;

  const questionnaireData = {
    ...template,
    patientUid,
    practitionerId: practitionerId || null,
    status: 'pending',
    assignedAt: timestamp,
    completedAt: null,
    responses: {},
  };

  // DOUBLE-WRITE (root + subcollection)
  
  // 1. Collection root (pour API Backend-First)
  const rootRef = db.collection('questionnaires').doc(uniqueId);
  batch.set(rootRef, questionnaireData);

  // 2. Sous-collection (pour compatibilit√©)
  const subRef = db
    .collection('patients')
    .doc(patientUid)
    .collection('questionnaires')
    .doc(template.id);
  batch.set(subRef, questionnaireData);
});
```

### 2. Fonction manuelle temporaire

**Fichier**: `functions/src/manualAssignQuestionnaires.ts` (NOUVEAU)

Fonction Cloud callable pour assigner manuellement les questionnaires aux patients existants.

**URL**: 
```
https://europe-west1-neuronutrition-app.cloudfunctions.net/manualAssignQuestionnaires?email=martialcayre@live.fr&secret=TEMP_SECRET_2025
```

---

## üîß Solution pour le patient existant

### Option 1: Appeler la fonction manuelle (RECOMMAND√â)

```bash
curl "https://europe-west1-neuronutrition-app.cloudfunctions.net/manualAssignQuestionnaires?email=martialcayre@live.fr&secret=TEMP_SECRET_2025"
```

### Option 2: Assignation manuelle via Console Firebase

1. Aller sur [Firebase Console](https://console.firebase.google.com/project/neuronutrition-app/firestore)
2. Collection `patients` ‚Üí chercher `martialcayre@live.fr` ‚Üí noter l'UID
3. Collection `questionnaires` ‚Üí Cr√©er 4 documents:

**IDs des documents**:
- `plaintes-et-douleurs_{UID}`
- `life-journey_{UID}`
- `nutri-assessment_{UID}`
- `dnsm_{UID}`

**Structure de chaque document**:
```json
{
  "id": "plaintes-et-douleurs",
  "title": "Mes plaintes actuelles et troubles ressentis",
  "category": "Mode de vie",
  "description": "√âvaluez l'intensit√© de vos troubles actuels",
  "patientUid": "{UID_DU_PATIENT}",
  "practitionerId": "{UID_DU_PRATICIEN}",
  "status": "pending",
  "assignedAt": {TIMESTAMP},
  "completedAt": null,
  "responses": {}
}
```

---

## üéØ Impact des modifications

### Pour les nouveaux patients
 Les questionnaires seront automatiquement assign√©s avec le double-write lors de l'activation du compte.

### Pour les patients existants
 N√©cessitent une assignation manuelle (via fonction ou console).

### Architecture
 Respect de l'architecture Backend-First (collection root)  
 Compatibilit√© maintenue (sous-collection)  
 Pas de breaking change pour le code existant

---

## üì¶ Fichiers modifi√©s

- ‚úÖ `functions/src/index.ts` (activatePatient)
- ‚úÖ `functions/src/manualAssignQuestionnaires.ts` (NOUVEAU)
- ‚úÖ `functions/src/index.ts` (export de manualAssignQuestionnaires)

## ‚úÖ Tests √† effectuer

1. [ ] Appeler `manualAssignQuestionnaires` pour martialcayre@live.fr
2. [ ] V√©rifier dans Console Firebase que les 4 documents existent dans `questionnaires/`
3. [ ] Se connecter au compte patient et v√©rifier que les questionnaires s'affichent
4. [ ] Cr√©er un nouveau compte patient test et v√©rifier l'assignation automatique

---

## üîê S√©curit√©

 La fonction `manualAssignQuestionnaires` utilise un secret temporaire. **√Ä SUPPRIMER** apr√®s utilisation.

Apr√®s usage:
1. Supprimer la fonction: `firebase functions:delete manualAssignQuestionnaires`
2. Retirer l'export du fichier `functions/src/index.ts`
3. Supprimer le fichier `functions/src/manualAssignQuestionnaires.ts`

---

**Statut**: ‚úÖ Correction d√©ploy√©e, en attente de test
