/**\n * üß™ Tests d'Int√©gration End-to-End - Syst√®me d'√Çge NeuroNutrition\n * \n * Tests Playwright pour valider le workflow complet de d√©tection d'√¢ge\n * et adaptation de l'interface utilisateur\n */\n\nimport { test, expect } from '@playwright/test';\n\n// üè∑Ô∏è Configuration des tests par √¢ge\nconst TEST_PATIENTS = {\n  kid: {\n    name: 'Emma Enfant',\n    birthDate: '2017-03-15', // 8 ans\n    email: 'emma.enfant@test.com',\n    expectedVariant: 'kid',\n    expectedAge: 8\n  },\n  teen: {\n    name: 'Lucas Ado',\n    birthDate: '2009-07-22', // 16 ans\n    email: 'lucas.ado@test.com',\n    expectedVariant: 'teen',\n    expectedAge: 16\n  },\n  adult: {\n    name: 'Marie Adulte',\n    birthDate: '1990-11-14', // 35 ans\n    email: 'marie.adulte@test.com',\n    expectedVariant: 'adult',\n    expectedAge: 35\n  }\n};\n\ntest.describe('üéØ Workflow Complet D√©tection d\\'√Çge', () => {\n  test.beforeEach(async ({ page }) => {\n    // Setup initial de l'environnement de test\n    await page.goto('http://localhost:5173'); // App patient\n  });\n  \n  test('üßí Workflow Patient Enfant (8 ans) avec Aide Parentale', async ({ page }) => {\n    const patient = TEST_PATIENTS.kid;\n    \n    // 1Ô∏è‚É£ Inscription patient\n    await page.click('[data-testid=\"signup-button\"]');\n    await page.fill('[data-testid=\"email-input\"]', patient.email);\n    await page.fill('[data-testid=\"name-input\"]', patient.name);\n    \n    // 2Ô∏è‚É£ Remplissage identification avec date de naissance\n    await page.click('[data-testid=\"continue-button\"]');\n    await page.fill('[data-testid=\"birthdate-input\"]', patient.birthDate);\n    await page.click('[data-testid=\"save-identification\"]');\n    \n    // 3Ô∏è‚É£ V√©rification d√©tection d'√¢ge automatique\n    await expect(page.locator('[data-testid=\"patient-age\"]')).toContainText('8 ans');\n    await expect(page.locator('[data-testid=\"age-variant\"]')).toContainText('kid');\n    \n    // 4Ô∏è‚É£ Assignation questionnaires (simul√©e par praticien)\n    await page.evaluate(() => {\n      // Simulation de l'assignation via Cloud Function\n      window.postMessage({\n        type: 'QUESTIONNAIRES_ASSIGNED',\n        payload: {\n          ageVariant: 'kid',\n          patientAge: 8,\n          requiresParentAssistance: true\n        }\n      }, '*');\n    });\n    \n    // 5Ô∏è‚É£ Navigation vers questionnaires\n    await page.click('[data-testid=\"questionnaires-tab\"]');\n    \n    // 6Ô∏è‚É£ V√©rification interface enfant\n    await expect(page.locator('h1')).toContainText('üåü Questionnaire pour toi !');\n    await expect(page.locator('[data-testid=\"parent-help-notice\"]'))\n      .toContainText('Papa ou maman peuvent t\\'aider');\n    \n    // 7Ô∏è‚É£ Ouverture d'un questionnaire\n    await page.click('[data-testid=\"questionnaire-card\"]:first-child');\n    \n    // 8Ô∏è‚É£ V√©rification adaptation visuelle enfant\n    await expect(page.locator('.questionnaire-container')).toHaveClass(/yellow-300/);\n    await expect(page.locator('.question-title')).toContainText('üåü');\n    await expect(page.locator('.progress-text')).toContainText('üéà Tu as r√©pondu');\n    \n    // 9Ô∏è‚É£ Test mode aide parentale\n    await expect(page.locator('[data-testid=\"parent-assistance\"]')).toBeVisible();\n    await page.click('[data-testid=\"toggle-parent-help\"]');\n    await expect(page.locator('[data-testid=\"parent-help-status\"]'))\n      .toContainText('Papa ou maman m\\'aide');\n    \n    // üîü Test r√©ponse question avec encouragement\n    await page.click('[data-testid=\"answer-option-2\"]');\n    \n    // V√©rification possible message d'encouragement (al√©atoire)\n    const encouragementVisible = await page.locator('[data-testid=\"encouragement\"]').isVisible();\n    if (encouragementVisible) {\n      await expect(page.locator('[data-testid=\"encouragement\"]'))\n        .toContainText(/üåü|üéà|ü¶ã|üåà|‚≠ê/);\n    }\n    \n    // 1Ô∏è‚É£1Ô∏è‚É£ V√©rification navigation adapt√©e\n    await expect(page.locator('[data-testid=\"next-button\"]'))\n      .toContainText('Question suivante ‚Üí');\n  });\n  \n  test('üßë Workflow Patient Adolescent (16 ans) Autonome', async ({ page }) => {\n    const patient = TEST_PATIENTS.teen;\n    \n    // Parcours similaire mais v√©rifie adaptations teen\n    await page.click('[data-testid=\"signup-button\"]');\n    await page.fill('[data-testid=\"email-input\"]', patient.email);\n    await page.fill('[data-testid=\"name-input\"]', patient.name);\n    await page.click('[data-testid=\"continue-button\"]');\n    await page.fill('[data-testid=\"birthdate-input\"]', patient.birthDate);\n    await page.click('[data-testid=\"save-identification\"]');\n    \n    // V√©rification d√©tection teen\n    await expect(page.locator('[data-testid=\"patient-age\"]')).toContainText('16 ans');\n    await expect(page.locator('[data-testid=\"age-variant\"]')).toContainText('teen');\n    \n    // Simulation assignation\n    await page.evaluate(() => {\n      window.postMessage({\n        type: 'QUESTIONNAIRES_ASSIGNED',\n        payload: {\n          ageVariant: 'teen',\n          patientAge: 16,\n          requiresParentAssistance: false\n        }\n      }, '*');\n    });\n    \n    await page.click('[data-testid=\"questionnaires-tab\"]');\n    \n    // Interface teen\n    await expect(page.locator('h1')).toContainText('üí´ Ton questionnaire');\n    await expect(page.locator('[data-testid=\"parent-help-notice\"]')).not.toBeVisible();\n    \n    await page.click('[data-testid=\"questionnaire-card\"]:first-child');\n    \n    // Style teen\n    await expect(page.locator('.questionnaire-container')).toHaveClass(/blue-300/);\n    await expect(page.locator('.question-title')).toContainText('üí´');\n    \n    // Pas d'assistance parentale\n    await expect(page.locator('[data-testid=\"parent-assistance\"]')).not.toBeVisible();\n    \n    // Navigation teen\n    await expect(page.locator('[data-testid=\"next-button\"]')).toContainText('Suivant ‚Üí');\n  });\n  \n  test('üë®‚Äç‚öïÔ∏è Interface Praticien - Biblioth√®que avec Variantes', async ({ page }) => {\n    // Navigation vers interface praticien\n    await page.goto('http://localhost:5174'); // App praticien\n    \n    // Connexion praticien\n    await page.fill('[data-testid=\"email-input\"]', 'praticien@test.com');\n    await page.fill('[data-testid=\"password-input\"]', 'password123');\n    await page.click('[data-testid=\"login-button\"]');\n    \n    // Navigation vers patient\n    await page.click('[data-testid=\"patients-tab\"]');\n    await page.click('[data-testid=\"patient-card\"]:first-child');\n    \n    // Ouverture biblioth√®que questionnaires\n    await page.click('[data-testid=\"assign-questionnaires\"]');\n    \n    // V√©rification chargement biblioth√®que\n    await expect(page.locator('[data-testid=\"library-stats\"]')).toBeVisible();\n    await expect(page.locator('[data-testid=\"category-filter\"]')).toBeVisible();\n    \n    // V√©rification info patient avec √¢ge\n    await expect(page.locator('[data-testid=\"patient-age-badge\"]')).toContainText(/\\d+ ans/);\n    await expect(page.locator('[data-testid=\"age-variant-badge\"]'))\n      .toContainText(/(adult|teen|kid)/);\n    \n    // V√©rification questionnaires avec variantes\n    const questionnaireCards = page.locator('[data-testid^=\"questionnaire-template-\"]');\n    await expect(questionnaireCards.first()).toBeVisible();\n    \n    // V√©rification indication variantes disponibles\n    const variantBadge = page.locator('[data-testid=\"has-variants-badge\"]').first();\n    if (await variantBadge.isVisible()) {\n      await expect(variantBadge).toContainText('Variantes √¢ge');\n    }\n    \n    // S√©lection et assignation\n    await page.click('[data-testid=\"questionnaire-template-stress\"]:first-child');\n    await page.click('[data-testid=\"assign-selected-button\"]');\n    \n    // V√©rification message succ√®s avec info √¢ge\n    await expect(page.locator('[data-testid=\"success-message\"]'))\n      .toContainText(/questionnaire.* assign√©.* variante:/);\n  });\n  \n  test('üö´ Blocage Assignation Sans Identification', async ({ page }) => {\n    // Tentative d'assignation sans date de naissance\n    await page.click('[data-testid=\"signup-button\"]');\n    await page.fill('[data-testid=\"email-input\"]', 'sans.birthdate@test.com');\n    await page.fill('[data-testid=\"name-input\"]', 'Patient Sans Age');\n    await page.click('[data-testid=\"continue-button\"]');\n    \n    // Skip identification volontairement\n    await page.click('[data-testid=\"skip-identification\"]');\n    \n    // Simulation tentative assignation depuis praticien\n    await page.evaluate(() => {\n      // Simulation de l'appel Cloud Function qui devrait √©chouer\n      return fetch('/api/assignSelectedQuestionnaires', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          patientUid: 'sans-birthdate-uid',\n          questionnaireIds: ['questionnaire-stress']\n        })\n      });\n    });\n    \n    // V√©rification message d'erreur\n    await expect(page.locator('[data-testid=\"error-message\"]'))\n      .toContainText('identification patient requise');\n    \n    // V√©rification redirection vers identification\n    await expect(page.url()).toContain('/identification');\n    await expect(page.locator('[data-testid=\"identification-required-notice\"]'))\n      .toContainText('Vous devez remplir votre identification');\n  });\n  \n  test('üîÑ Transition d\\'√Çge (Kid ‚Üí Teen)', async ({ page }) => {\n    // Simulation d'un patient qui grandit\n    const patientEvolutif = {\n      uid: 'patient-evolutif',\n      initialBirthDate: '2012-01-01', // 13 ans tout juste\n      email: 'evolutif@test.com'\n    };\n    \n    // Setup initial comme kid (12 ans)\n    await page.evaluate((data) => {\n      localStorage.setItem('patient-data', JSON.stringify({\n        ...data,\n        initialBirthDate: '2013-01-01' // 12 ans\n      }));\n    }, patientEvolutif);\n    \n    await page.goto('http://localhost:5173/dashboard');\n    \n    // V√©rification √©tat kid initial\n    await expect(page.locator('[data-testid=\"age-variant\"]')).toContainText('kid');\n    await expect(page.locator('h1')).toContainText('üåü');\n    \n    // Simulation passage du temps (anniversaire)\n    await page.evaluate((data) => {\n      localStorage.setItem('patient-data', JSON.stringify({\n        ...data,\n        initialBirthDate: data.initialBirthDate // Maintenant 13 ans\n      }));\n    }, patientEvolutif);\n    \n    // Refresh pour recalcul √¢ge\n    await page.reload();\n    \n    // V√©rification transition vers teen\n    await expect(page.locator('[data-testid=\"age-variant\"]')).toContainText('teen');\n    await expect(page.locator('h1')).toContainText('üí´');\n    await expect(page.locator('[data-testid=\"parent-help-notice\"]')).not.toBeVisible();\n  });\n});\n\ntest.describe('üé® Tests d\\'Interface Adaptative', () => {\n  test('Responsive Design selon l\\'√¢ge', async ({ page, viewport }) => {\n    // Test sur diff√©rentes tailles d'√©cran\n    for (const patient of Object.values(TEST_PATIENTS)) {\n      await page.goto(`http://localhost:5173/questionnaire-demo?age=${patient.expectedAge}`);\n      \n      // Mobile\n      await page.setViewportSize({ width: 375, height: 667 });\n      await page.waitForTimeout(500);\n      \n      if (patient.expectedVariant === 'kid') {\n        // Interface kid doit √™tre plus espac√©e sur mobile\n        await expect(page.locator('.questionnaire-container')).toHaveCSS('padding', /6|8/);\n        await expect(page.locator('.question-title')).toHaveCSS('font-size', /1.5|2/);\n      }\n      \n      // Desktop\n      await page.setViewportSize({ width: 1920, height: 1080 });\n      await page.waitForTimeout(500);\n      \n      // V√©rifications layout desktop\n      await expect(page.locator('.questionnaire-container')).toBeVisible();\n    }\n  });\n  \n  test('Accessibilit√© selon l\\'√¢ge', async ({ page }) => {\n    // Kid: Doit avoir des contrastes √©lev√©s et grandes tailles\n    await page.goto('http://localhost:5173/questionnaire-demo?variant=kid');\n    \n    const questionTitle = page.locator('.question-title');\n    await expect(questionTitle).toHaveCSS('font-size', /lg|xl|2xl/);\n    \n    // V√©rification couleurs contrast√©es (kid)\n    const buttons = page.locator('[data-testid^=\"answer-button\"]');\n    await expect(buttons.first()).toHaveCSS('border-width', '2px'); // Bordures visibles\n    \n    // Teen: Interface √©quilibr√©e\n    await page.goto('http://localhost:5173/questionnaire-demo?variant=teen');\n    await expect(page.locator('h1')).toHaveCSS('color', /rgb\\(59, 130, 246\\)/);\n    \n    // Adult: Interface standard\n    await page.goto('http://localhost:5173/questionnaire-demo?variant=adult');\n    await expect(page.locator('h1')).toHaveCSS('color', /rgb\\(75, 85, 99\\)/);\n  });\n});\n\ntest.describe('‚ö° Tests de Performance', () => {\n  test('G√©n√©ration variantes en temps r√©el', async ({ page }) => {\n    // Mesure du temps de g√©n√©ration des variantes\n    const startTime = Date.now();\n    \n    await page.goto('http://localhost:5174/library-performance-test');\n    \n    // Chargement biblioth√®que compl√®te\n    await page.waitForSelector('[data-testid=\"library-loaded\"]');\n    \n    const loadTime = Date.now() - startTime;\n    \n    // Doit charger en moins de 2 secondes\n    expect(loadTime).toBeLessThan(2000);\n    \n    // V√©rification cache des variantes\n    await page.reload();\n    const cachedStartTime = Date.now();\n    await page.waitForSelector('[data-testid=\"library-loaded\"]');\n    const cachedLoadTime = Date.now() - cachedStartTime;\n    \n    // Rechargement doit √™tre plus rapide (cache)\n    expect(cachedLoadTime).toBeLessThan(loadTime * 0.5);\n  });\n});