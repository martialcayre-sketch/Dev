/**\n * üß† NeuroNutrition - API Biblioth√®que Questionnaires pour Praticiens\n * \n * Cloud Function pour acc√®s s√©curis√© √† la biblioth√®que compl√®te des questionnaires\n */\n\nimport * as admin from 'firebase-admin';\nimport * as logger from 'firebase-functions/logger';\nimport { HttpsError, onCall } from 'firebase-functions/v2/https';\nimport { getAvailableTemplates, getLibraryStats, getQuestionnairesByCategory } from '@neuronutrition/shared-questionnaires';\n\n// Ensure Admin SDK is initialized\nif (!admin.apps.length) {\n  admin.initializeApp();\n}\n\nconst db = admin.firestore();\n\n/**\n * üîê Validation: V√©rifier que l'utilisateur est un praticien autoris√©\n */\nasync function validatePractitioner(uid: string): Promise<boolean> {\n  try {\n    const userRecord = await admin.auth().getUser(uid);\n    const claims = userRecord.customClaims;\n    \n    return !!(claims && claims.practitioner);\n  } catch (error) {\n    logger.error('Error validating practitioner:', error);\n    return false;\n  }\n}\n\n/**\n * üìö Cloud Function: Obtenir la liste de tous les templates disponibles\n * \n * ACC√àS: Praticiens uniquement\n */\nexport const getQuestionnaireLibrary = onCall(async (request) => {\n  const ctx = request.auth;\n  if (!ctx) {\n    throw new HttpsError('unauthenticated', 'Authentication required');\n  }\n\n  // üîê VALIDATION PRATICIEN OBLIGATOIRE\n  const isPractitioner = await validatePractitioner(ctx.uid);\n  if (!isPractitioner) {\n    logger.warn(`Unauthorized access attempt to questionnaire library by user ${ctx.uid}`);\n    throw new HttpsError('permission-denied', 'Acc√®s r√©serv√© aux praticiens autoris√©s');\n  }\n\n  try {\n    logger.info(`Practitioner ${ctx.uid} accessing questionnaire library`);\n\n    // üìä R√©cup√©ration des templates et statistiques\n    const templates = getAvailableTemplates();\n    const stats = getLibraryStats();\n    \n    // üìã Groupement par cat√©gorie pour l'interface\n    const categories: Record<string, any[]> = {};\n    templates.forEach(template => {\n      if (!categories[template.category]) {\n        categories[template.category] = [];\n      }\n      categories[template.category].push(template);\n    });\n\n    return {\n      success: true,\n      data: {\n        templates,\n        categories,\n        stats,\n        practitionerId: ctx.uid,\n        accessTime: admin.firestore.FieldValue.serverTimestamp()\n      }\n    };\n\n  } catch (error: any) {\n    logger.error('Error retrieving questionnaire library:', error);\n    throw new HttpsError('internal', `Failed to retrieve library: ${error.message}`);\n  }\n});\n\n/**\n * üéØ Cloud Function: Assigner des questionnaires sp√©cifiques √† un patient\n * \n * NOUVEAU: Avec s√©lection manuelle + d√©tection d'√¢ge automatique\n */\nexport const assignSelectedQuestionnaires = onCall(async (request) => {\n  const ctx = request.auth;\n  if (!ctx) {\n    throw new HttpsError('unauthenticated', 'Authentication required');\n  }\n\n  // üîê VALIDATION PRATICIEN\n  const isPractitioner = await validatePractitioner(ctx.uid);\n  if (!isPractitioner) {\n    throw new HttpsError('permission-denied', 'Acc√®s r√©serv√© aux praticiens');\n  }\n\n  const { patientUid, questionnaireIds } = request.data as {\n    patientUid?: string;\n    questionnaireIds?: string[];\n  };\n\n  if (!patientUid || !questionnaireIds || !Array.isArray(questionnaireIds)) {\n    throw new HttpsError('invalid-argument', 'patientUid et questionnaireIds requis');\n  }\n\n  try {\n    logger.info(`Practitioner ${ctx.uid} assigning ${questionnaireIds.length} questionnaires to patient ${patientUid}`);\n\n    // üß† VALIDATION √ÇGE ET IDENTIFICATION (comme dans assignQuestionnaires)\n    const patientDoc = await db.collection('patients').doc(patientUid).get();\n    const patientData = patientDoc.data();\n    \n    // Import dynamique pour √©viter les d√©pendances circulaires\n    const { canAssignQuestionnaires, detectPatientAge } = await import('@neuronutrition/shared-core');\n    \n    const ageValidation = canAssignQuestionnaires({\n      uid: patientUid,\n      birthDate: patientData?.identification?.birthDate\n    });\n\n    if (!ageValidation.canAssign) {\n      throw new HttpsError('failed-precondition', ageValidation.reason || 'Identification patient requise');\n    }\n\n    const ageResult = detectPatientAge({\n      uid: patientUid,\n      birthDate: patientData?.identification?.birthDate\n    });\n\n    // üìù CR√âATION DES QUESTIONNAIRES S√âLECTIONN√âS\n    const batch = db.batch();\n    const now = admin.firestore.FieldValue.serverTimestamp();\n    const assignedQuestionnaires = [];\n\n    for (const templateId of questionnaireIds) {\n      // Import dynamique des questionnaires\n      const { getQuestionnaireById } = await import('@neuronutrition/shared-questionnaires');\n      const questionnaireVariant = getQuestionnaireById(templateId, ageResult.variant);\n      \n      if (!questionnaireVariant) {\n        logger.warn(`Questionnaire template ${templateId} not found for variant ${ageResult.variant}`);\n        continue;\n      }\n\n      const questionnaireData = {\n        ...questionnaireVariant.metadata,\n        patientUid,\n        practitionerId: ctx.uid,\n        status: 'pending',\n        assignedAt: now,\n        completedAt: null,\n        responses: {},\n        // Informations d'√¢ge\n        patientAge: ageResult.ageInYears,\n        ageVariant: ageResult.variant,\n        requiresParentAssistance: ageResult.variant === 'kid'\n      };\n\n      // √âcriture root collection\n      const rootRef = db.collection('questionnaires').doc(`${templateId}_${patientUid}`);\n      batch.set(rootRef, questionnaireData);\n      \n      assignedQuestionnaires.push({\n        id: templateId,\n        title: questionnaireVariant.metadata.title,\n        variant: ageResult.variant\n      });\n    }\n\n    await batch.commit();\n\n    // üìä MISE √Ä JOUR PATIENT\n    await db.collection('patients').doc(patientUid).set({\n      hasQuestionnairesAssigned: true,\n      lastAssignmentBy: ctx.uid,\n      lastAssignmentAt: now,\n      pendingQuestionnairesCount: admin.firestore.FieldValue.increment(assignedQuestionnaires.length)\n    }, { merge: true });\n\n    // üîî NOTIFICATION PATIENT\n    await db\n      .collection('patients')\n      .doc(patientUid)\n      .collection('notifications')\n      .add({\n        type: 'questionnaires_assigned',\n        title: 'Nouveaux questionnaires assign√©s',\n        message: `${assignedQuestionnaires.length} questionnaires vous ont √©t√© assign√©s par votre praticien.`,\n        read: false,\n        createdAt: now,\n        link: '/dashboard/questionnaires',\n        assignedBy: ctx.uid\n      });\n\n    logger.info(`Successfully assigned ${assignedQuestionnaires.length} questionnaires to patient ${patientUid}`);\n\n    return {\n      success: true,\n      assigned: assignedQuestionnaires,\n      patientAge: ageResult.ageInYears,\n      ageVariant: ageResult.variant,\n      message: `${assignedQuestionnaires.length} questionnaires assign√©s avec succ√®s`\n    };\n\n  } catch (error: any) {\n    logger.error('Error assigning selected questionnaires:', error);\n    throw new HttpsError('internal', `Failed to assign questionnaires: ${error.message}`);\n  }\n});